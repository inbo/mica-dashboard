{% extends "dashboard/base.html" %}

{% load static %}

{% block extrahead %}
    <link rel="stylesheet"
          href="https://openlayers.org/en/main/css/ol.css"
          type="text/css">
    <style>
        .fade-enter-active, .fade-leave-active {
            transition: opacity 1s;
        }

        .fade-enter, .fade-leave-to /* .fade-leave-active below version 2.1.8 */
        {
            opacity: 0;
        }
    </style>
{% endblock %}

{% block content-fixed %}
    <h1 class="display-4">MICA Dashboard</h1>
    <p class="font-weight-light">
        The MICA dashboard shows data originating ... Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus nunc diam, iaculis et lectus vel, iaculis lobortis lectus. Curabitur magna felis, consectetur ac ante in, hendrerit aliquam erat. Nunc condimentum tellus ac diam rhoncus, sed facilisis libero placerat. Phasellus tempus felis vel mi blandit tristique. Donec porta, sapien vel scelerisque sollicitudin, arcu purus posuere risus, ut sagittis arcu est in mi. Cras finibus quam nibh, nec lobortis magna pretium ut. Duis lobortis ac nibh eu aliquet. Morbi vehicula faucibus augue sed sollicitudin. Pellentesque tincidunt sem eu vehicula eleifend. Nunc nec quam id dolor dictum congue et sed elit.
    </p>
{% endblock %}

{% block content-fluid %}
        <div id="app">
            <div class="row">
                <div class="col-3 bg-dark text-white shadow">
                <form>
                    <h4 class="my-3 text-center">Data filtering</h4>
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label col-form-label-sm" for="selectedDataset">Source dataset</label>
                        <select class="col-sm-5 form-control form-control-sm" id="selectedDataset"
                                    v-model="selectedDatasetId">
                            <option value="null">-- ALL --</option>
                            <option v-for="dataset in availableDatasets" :key="dataset.id" :value="dataset.id">[[
                                    dataset.name ]]
                            </option>
                        </select>
                    </div>

                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label col-form-label-sm" for="selectedSpecies">Species</label>
                        <select class="col-sm-5 form-control form-control-sm" id="selectedDataset"
                                v-model="selectedSpeciesId">
                            <option value="null">-- ALL --</option>
                            <option v-for="species in availableSpecies" :key="species.id" :value="species.id">[[
                                    species.name ]]
                            </option>
                        </select>
                    </div>

                    <div class="form-group">
                        <input type="checkbox"  id="onlyRecentOccurrences"
                                       v-model="onlyRecentOccurrences">
                        <label class="col-form-label col-form-label-sm" for="onlyRecentOccurrences">Show only recent (2019+) occurrences</label>
                    </div>

                    <h4 class="my-3 text-center">Map style</h4>
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label col-form-label-sm" for="selectedLayer">Layer type</label>
                        <select class="col-sm-5 form-control form-control-sm" id="selectedLayer" v-model="visibleLayer">
                            <option v-for="layer in layerTypes" :value="layer.id">[[ layer.label ]]</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="heatmapRadius">Heatmap radius</label>
                        <input id="heatmapRadius" type="range" min="1" max="10" v-model.number="heatmapRadius"
                               :disabled="visibleLayer !== 'heatmapLayer'">
                    </div>

                    <div class="form-group">
                        <label for="heatmapBlur">Heatmap blur</label>
                        <input id="heatmapBlur" type="range" min="1" max="50" v-model.number="heatmapBlur"
                               :disabled="visibleLayer !== 'heatmapLayer'">
                    </div>
                </form>
            </div>

                <div class="col-9">
                <transition name="fade">
                    <div v-if="loading" class="alert alert-primary" role="alert">
                        <h6>Please wait...</h6>
                        Data is loading...
                    </div>
                </transition>
                <div v-if="!loading">
                    <p class="alert alert-primary" role="alert">[[ occurrencesCounter ]] occurrence(s) found.</p>

                    <h2>Map view</h2>
                    <dashboard-map v-if="occurrences" :occurrences="occurrences"
                                   :initial-lat="51.58" :initial-lon="4.67" :initial-zoom="7"
                                   :heatmap-blur="heatmapBlur" :heatmap-radius="heatmapRadius"
                                   :visible-layer="visibleLayer"
                    ></dashboard-map>

                    <h2>Table view</h2>
                    <dashboard-table :occurrences="occurrences"></dashboard-table>
                </div>
                </div>
            </div>
        </div>

    <script type="text/javascript">
        window.onload = function () {
            Vue.config.devtools = true;
            var App = new Vue({
                    el: '#app',
                    delimiters: ['[[', ']]'],
                    data() {
                        return {
                            occurrencesCsvUrl: "{% url 'dashboard-api-occurrences_csv' %}",
                            occurrences: null, // Array of objects: [{id: 1234, lon: 5.32, lat:50.12}, ...],

                            availableDatasetsUrl: "{% url 'dashboard-api-available-datasets' %}",
                            availableDatasets: [],
                            selectedDatasetId: null,

                            availableSpeciesUrl: "{% url 'dashboard-api-available-species' %}",
                            availableSpecies: [],
                            selectedSpeciesId: null,

                            onlyRecentOccurrences: true,

                            layerTypes: [
                                {id: 'pointsLayer', label:'Points (WebGL)'},
                                {id: 'clusterLayer', label:'Clusters'},
                                {id: 'heatmapLayer', label:'Heatmap'}
                            ],

                            heatmapBlur: 15,
                            heatmapRadius: 2,
                            visibleLayer: 'pointsLayer',

                            loadingMessage: '',
                            loading: true
                        }
                    },
                    computed: {
                        occurrencesCounter: function () {
                            return (this.occurrences ? this.occurrences.length : 0);
                        },

                        queryFiltersData: function () {
                            var obj = {
                                datasetId: this.selectedDatasetId,
                                speciesId: this.selectedSpeciesId,
                                onlyRecent: this.onlyRecentOccurrences
                            }

                            return this.clean(obj); // It helps with server side caching if we don't request unnecessary GET params
                        }
                    },
                    mounted() {
                        this.populateDatasetSelect();
                        this.populateSpeciesSelect();
                        this.getAndReplaceOccurrenceData();
                    },

                    watch: {
                        'selectedDatasetId': {
                            handler: function (newVal) {
                                this.getAndReplaceOccurrenceData();
                            },
                        },
                        'selectedSpeciesId': {
                            handler: function (newVal) {
                                this.getAndReplaceOccurrenceData();
                            },
                        },
                        'onlyRecentOccurrences': {
                            handler: function (newVal) {
                                this.getAndReplaceOccurrenceData();
                            },
                        }
                    },
                    methods: {
                        populateSpeciesSelect: function () {
                            var vm = this;
                            $.ajax({
                                url: this.availableSpeciesUrl,
                            }).done(function (data) {
                                vm.availableSpecies = data;
                            })
                        },
                        populateDatasetSelect: function () {
                            var vm = this;
                            $.ajax({
                                url: this.availableDatasetsUrl,
                            }).done(function (data) {
                                vm.availableDatasets = data;
                            })
                        },
                        finishedMountingMap: function () {
                            this.loading = false;
                        },
                        clean: function (obj) {
                            // Remove undefined or null properties from an object
                            clonedObj = Object.assign({}, obj);
                            for (var propName in clonedObj) {
                                if (clonedObj[propName] === null || clonedObj[propName] === undefined) {
                                    delete clonedObj[propName];
                                }
                            }
                            return clonedObj;
                        },
                        getAndReplaceOccurrenceData: function () {
                            let vm = this;

                            this.loading = true;
                            $.ajax({
                                url: this.occurrencesCsvUrl,
                                data: vm.queryFiltersData,
                                dataType: "text"
                            }).done(function (data) {
                                let newOccurrences = [];

                                if (data !== "") {
                                    data.split('\n').forEach(function (row) {
                                    var splitted = row.split(',')
                                    newOccurrences.push({
                                        id: splitted[0],
                                        lon: splitted[1],
                                        lat: splitted[2],
                                        speciesId: splitted[3],
                                        datasetId: splitted[4]}
                                        );
                                    });
                                }
                                vm.occurrences = newOccurrences;
                                vm.loading = false;
                            });
                        }
                    }

                })
            ;
        };
    </script>
{% endblock %}

{% block extrabodyend %}
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
    <script src="https://openlayers.org/en/main/build/ol.js"></script>
    <script src="{% static 'dashboard/dashboard.js' %}"></script>
{% endblock %}