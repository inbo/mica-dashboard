{% extends "dashboard/base.html" %}

{% load static %}

{% block extrahead %}
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/css/ol.css"
          type="text/css">
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col"><h1>Rats data</h1></div>
    </div>

    <div class="row">
        <div class="col">
            <div id="app">
                <form>
                    <div class="form-group">
                        <label for="selectedLayer">Layer type</label>
                        <select class="form-control" id="selectedLayer" v-model="visibleLayer">
                            <option>cluster</option>
                            <option>heatmap</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="heatmapRadius">Heatmap radius</label>
                        <input id="heatmapRadius" type="range" min="1" max="10" v-model.number="heatmapRadius" :disabled="visibleLayer !== 'heatmap'">
                    </div>

                    <div class="form-group">
                        <label for="heatmapBlur">Heatmap radius</label>
                        <input id="heatmapBlur" type="range" min="1" max="50" v-model.number="heatmapBlur" :disabled="visibleLayer !== 'heatmap'">
                    </div>
                </form>

                <dashboard-map v-if="occurrences" :occurrences="occurrences"
                               :initial-lat="50.63" :initial-lon="4.67" :initial-zoom="8"
                               :heatmap-blur="heatmapBlur" :heatmap-radius="heatmapRadius"
                               :visible-layer="visibleLayer"
                ></dashboard-map>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        window.onload = function () {
            Vue.config.devtools = true;
            var App = new Vue({
                el: '#app',
                delimiters: ['[[', ']]'],
                data() {
                    return {
                        occurrencesCsvUrl: "{% url 'dashboard-occurrences_csv' %}",
                        occurrences: null, // Array of objects: [{id: 1234, lon: 5.32, lat:50.12}, ...],

                        heatmapBlur: 15,
                        heatmapRadius: 2,
                        visibleLayer: 'cluster'

                    }
                },
                mounted() {
                    this.getAndReplaceOccurrenceData();
                },
                methods: {
                    getAndReplaceOccurrenceData: function () {
                        var vm = this;

                        $.ajax({
                            url: this.occurrencesCsvUrl,
                            dataType: "text"
                        }).done(function (data) {
                            var dataLines = data.split('\n');
                            var newOccurrences = []
                            dataLines.forEach(function (row) {
                                var splitted = row.split(',')
                                newOccurrences.push({id: splitted[0], lon: splitted[1], lat:splitted[2]});
                            });
                            vm.occurrences = newOccurrences;
                        });
                    }
                }

            });
        };
    </script>
{% endblock %}

{% block extrabodyend %}
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.4.3/build/ol.js"></script>
    <script src="{% static 'dashboard/dashboard.js' %}"></script>
{% endblock %}