{% extends "dashboard/base.html" %}

{% load static %}

{% block extrahead %}
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css"
          type="text/css">
{% endblock %}

{% block content-fluid %}
    <div id="app">
        <div class="row">
            <div class="col-3 text-white shadow" style="background-color: #242d66;">
                <form>
                    <h4 class="my-3 text-center">Data filtering</h4>
                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label col-form-label-sm" for="selectedDataset">Source
                            dataset</label>
                        <select class="col-sm-5 form-control form-control-sm" id="selectedDataset"
                                v-model="selectedFilters.datasetId">
                            <option :value="null">-- ALL --</option>
                            <option v-for="dataset in availableDatasets" :key="dataset.id" :value="dataset.id">[[
                                    dataset.name ]]
                            </option>
                        </select>
                    </div>

                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label col-form-label-sm" for="selectedSpecies">Species</label>
                        <select class="col-sm-5 form-control form-control-sm" id="selectedSpecies"
                                v-model="selectedFilters.speciesId">
                            <option :value="null">-- ALL --</option>
                            <option v-for="species in availableSpecies" :key="species.id" :value="species.id">[[
                                    species.name ]]
                            </option>
                        </select>
                    </div>

                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label col-form-label-sm" for="selectedSpecies">Catches or
                            observations?</label>
                        <select class="col-sm-5 form-control form-control-sm" id="selectedSpecies"
                                v-model="selectedFilters.recordsType">
                            <option :value="null">Both</option>
                            <option value="catches">Catches</option>
                            <option value="observations">Observations</option>
                        </select>
                    </div>

                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label col-form-label-sm" for="selectedOverlay">MICA area</label>
                        <select class="col-sm-5 form-control form-control-sm" id="selectedOverlay"
                                v-model="selectedOverlayId">
                            <option :value="null">-- Everywhere --</option>
                            <option v-for="overlay in availableOverlays" :key="overlay.id" :value="overlay.id">[[
                                    overlay.name ]]
                            </option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="col-form-label col-form-label-sm" for="startDate">Start date</label>
                        <input class="form-control form-control-sm" type="date" id="startDate"
                               v-model="selectedFilters.startDate">
                    </div>

                    <div class="form-group">
                        <label class="col-form-label col-form-label-sm" for="endDate">End date</label>
                        <input class="form-control form-control-sm" type="date" id="endDate"
                               v-model="selectedFilters.endDate">
                    </div>

                    <h4 class="my-3 text-center">Map style</h4>

                    <div class="form-group row">
                        <label class="col-sm-6 col-form-label col-form-label-sm" for="opacity">Opacity</label>
                        <input type="range" class="col-sm-5 custom-range" id="opacity" min="0" max="1" step="0.1"
                               v-model.number="dataLayerOpacity">
                    </div>

                    <div class="form-group">
                        <input type="checkbox" id="showHexaonCounters"
                               v-model="showHexagonCounters">
                        <label class="col-form-label col-form-label-sm" for="showHexaonCounters">Show hexagon
                            counters</label>
                    </div>
                </form>
            </div>

            <div class="col-9">

                <div class="row mt-1">
                    <div class="col-sm-9">
                        <h1 class="display-4">Muskrat and Coypu monitor</h1>
                    </div>
                    <div class="col-sm-3">
                        <img class="img-fluid" src="{% static 'dashboard/img/MICA_logo.png' %}">
                    </div>
                </div>


                <p class="font-weight-light">
                    This dashboard attempts to give an overview of all muskrat and coypu observations (both catches and
                    field
                    observations) in Flanders, the Netherlands and certain areas in Germany. This dashboard is part of
                    the LIFE
                    MICA
                    project, in which innovative techniques are tested for a more efficient control of muskrat and coypu
                    populations, both invasive species. This dashboard will strengthen cooperation between neighboring
                    countries
                    because information on the presence of muskrats and coypu will be readily shared and used to inform
                    management
                    decisions.
                </p>

                <p class="font-weight-bold">
                    Be careful when interpreting the data! Not all data is updated regularly and more recent data may
                    therefore be incomplete.
                </p>

                <p class="font-weight-bold">
                    Latest data import: {{ latest_data_import.end }}
                </p>

                <hr>


                <dashboard-occurrence-counter :filters="selectedFilters"
                                              :counter-url="endpoints.counterUrl"></dashboard-occurrence-counter>

                <h2>Map view</h2>
                <dashboard-map
                        :initial-lat="51.58" :initial-lon="4.67" :initial-zoom="initialZoomLevel"
                        :min-max-url="endpoints.minMaxOccCountUrl"
                        :tile-server-url-template="endpoints.tileServerUrlTemplate"
                        :overlay-server-url="endpoints.areaGeojsonUrl"
                        :filters="selectedFilters"
                        :show-counters="showHexagonCounters"
                        :data-layer-opacity="dataLayerOpacity"
                        :overlay-id="selectedOverlayId"
                ></dashboard-map>

                <h2>Table view</h2>
                <dashboard-table :filters="selectedFilters"
                                 :occurrences-json-url="endpoints.occurrencesJsonUrl"></dashboard-table>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        window.onload = function () {
            Vue.config.devtools = true;
            new Vue({
                el: '#app',
                delimiters: ['[[', ']]'],
                data() {
                    return {
                        selectedFilters: {
                            datasetId: null,
                            speciesId: null,
                            areaIds: [],
                            startDate: this.firstDayInPreviousMonth().toISOString().substring(0, 10),
                            endDate: this.lastDayInPreviousMonth().toISOString().substring(0, 10),
                            recordsType: null, // null | catches | observations
                        },

                        endpoints: {
                            availableDatasetsUrl: "{% url 'dashboard-api-available-datasets' %}",
                            availableSpeciesUrl: "{% url 'dashboard-api-available-species' %}",
                            availableOverlaysUrl: "{% url 'dashboard-api-available-areas' %}",
                            areaGeojsonUrl: "{% url 'dashboard-api-area-geojson' id=1 %}".replace('1', '{id}'),
                            minMaxOccCountUrl: "{% url 'dashboard-api-min-max-in-grid' %}",
                            counterUrl: "{% url 'dashboard-api-occurrences-counter' %}",
                            occurrencesJsonUrl: "{% url 'dashboard-api-occurrences-json' %}",
                            tileServerUrlTemplate: "{% url 'dashboard-api-mvt-tiles' zoom=1 x=2 y=3%}".replace('1', '{z}').replace('2', '{x}').replace('3', '{y}')
                        },

                        availableDatasets: [],
                        availableSpecies: [],
                        availableOverlays: [],

                        showHexagonCounters: true,
                        initialZoomLevel: 7,
                        dataLayerOpacity: 0.9,
                        selectedOverlayId: null
                    }
                },
                watch: {
                    // Selecting an overlay also triggers filtering
                    selectedOverlayId: function (newOverlayId) {
                        if (newOverlayId !== null) {
                            this.selectedFilters.areaIds = [newOverlayId];
                        } else {
                            this.selectedFilters.areaIds = [];
                        }
                    }
                },
                mounted() {
                    this.populateDatasetSelect();
                    this.populateSpeciesSelect();
                    this.populateOverlaysSelect();
                },
                methods: {
                    firstDayInPreviousMonth() {
                        const date = new Date();
                        date.setDate(1);
                        date.setMonth(date.getMonth() - 1);
                        return date;
                    },
                    lastDayInPreviousMonth() {
                        const date = new Date();
                        date.setDate(0);
                        return date;
                    },
                    populateSpeciesSelect: function () {
                        var vm = this;
                        $.ajax({
                            url: this.endpoints.availableSpeciesUrl,
                        }).done(function (data) {
                            vm.availableSpecies = data;
                        })
                    },
                    populateDatasetSelect: function () {
                        var vm = this;
                        $.ajax({
                            url: this.endpoints.availableDatasetsUrl,
                        }).done(function (data) {
                            vm.availableDatasets = data;
                        })
                    },
                    populateOverlaysSelect: function () {
                        var vm = this;
                        $.ajax({
                            url: this.endpoints.availableOverlaysUrl,
                        }).done(function (data) {
                            vm.availableOverlays = data;
                        })
                    },
                    clean: function (obj) {
                        // Remove undefined or null properties from an object
                        clonedObj = Object.assign({}, obj);
                        for (var propName in clonedObj) {
                            if (clonedObj[propName] === null || clonedObj[propName] === undefined) {
                                delete clonedObj[propName];
                            }
                        }
                        return clonedObj;
                    },
                }

            })
            ;
        };
    </script>
{% endblock %}

{% block extrabodyend %}
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
    <script src="{% static 'dashboard/js/dashboard.js' %}"></script>
{% endblock %}